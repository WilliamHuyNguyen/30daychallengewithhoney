<!doctype html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TIỆM CHỮ PIXEL 2026</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=VT323&family=Dancing+Script:wght@700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --gold: #f0c95c;
      --red: #9f2f1b;
      --warm: #f6e6b0;
      --green: #40643a;
      --brown: #27170e;
      --ink: #100803;
      --panel: rgba(30, 14, 8, 0.78);
      --panel-alt: rgba(51, 26, 15, 0.9);
      --outline: #ffd67d;
      --shadow: #000;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: 'VT323', monospace;
      color: var(--warm);
      background:
        linear-gradient(rgba(24, 10, 6, 0.35), rgba(24, 10, 6, 0.55)),
        url('background.jpg') center/cover no-repeat fixed;
      display: grid;
      place-items: end center;
      overflow-x: hidden;
      image-rendering: pixelated;
    }

    .scanline::before {
      content: "";
      position: fixed;
      inset: 0;
      pointer-events: none;
      background: repeating-linear-gradient(
        to bottom,
        rgba(255, 255, 255, 0.02) 0,
        rgba(255, 255, 255, 0.02) 1px,
        transparent 1px,
        transparent 4px
      );
      z-index: 1;
    }

    .dialog {
      position: relative;
      z-index: 2;
      width: min(92vw, 950px);
      margin: 1rem;
      background: var(--panel);
      border: 4px solid var(--outline);
      box-shadow:
        0 0 0 4px var(--ink),
        0 0 0 8px var(--red),
        0 12px 0 0 var(--shadow);
      padding: 1rem 1.2rem 1.2rem;
      animation: floatDialog 2.2s ease-in-out infinite;
      backdrop-filter: blur(2px);
    }

    @keyframes floatDialog {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-6px); }
    }

    .dialog h1 {
      margin: 0 0 0.6rem;
      font-size: clamp(1.4rem, 3vw, 2.2rem);
      letter-spacing: 1px;
      color: var(--gold);
      text-shadow: 2px 2px 0 var(--brown);
    }

    .npc-line {
      margin: 0 0 0.8rem;
      font-size: clamp(1.2rem, 2.4vw, 1.8rem);
      color: #ffeec4;
      min-height: 2.2em;
    }

    .input-wrap {
      display: flex;
      gap: 0.8rem;
      flex-wrap: wrap;
      align-items: center;
      margin-top: 0.6rem;
    }

    input[type="text"] {
      flex: 1;
      min-width: 220px;
      font-family: inherit;
      font-size: clamp(1rem, 2.1vw, 1.4rem);
      border: 3px solid var(--outline);
      background: rgba(18, 9, 5, 0.9);
      color: #fff2c5;
      padding: 0.55rem 0.7rem;
      box-shadow: inset 0 0 0 2px var(--ink);
      outline: none;
    }

    input::placeholder { color: #d9be7f; }

    .pixel-btn {
      font-family: inherit;
      font-size: clamp(1rem, 2.2vw, 1.35rem);
      background: linear-gradient(#e4b64f, #b77a24);
      color: #2f160a;
      border: 3px solid #ffe3a3;
      box-shadow: 0 0 0 3px var(--ink), 0 5px 0 0 #522f0f;
      padding: 0.55rem 1rem;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 1px;
      transition: transform 120ms ease, filter 120ms ease;
    }

    .pixel-btn:hover { filter: brightness(1.05); }
    .pixel-btn:active { transform: translateY(2px); box-shadow: 0 0 0 3px var(--ink), 0 3px 0 0 #522f0f; }

    .hidden { display: none !important; }

    .loading {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      font-size: clamp(1.15rem, 2.3vw, 1.6rem);
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 2px;
      background: var(--gold);
      animation: blink 1s infinite;
    }
    .dot:nth-child(2) { animation-delay: 0.2s; }
    .dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes blink {
      0%, 100% { opacity: 0.2; transform: translateY(0); }
      50% { opacity: 1; transform: translateY(-3px); }
    }

    .overlay {
      position: fixed;
      inset: 0;
      z-index: 4;
      background: rgba(0, 0, 0, 0.6);
      display: grid;
      place-items: center;
      padding: 1rem;
    }

    .card {
      width: min(92vw, 560px);
      background: var(--panel-alt);
      border: 4px solid var(--outline);
      box-shadow: 0 0 0 4px var(--ink), 0 0 0 8px #7a2916, 0 12px 0 #120702;
      padding: 1rem;
      text-align: center;
    }

    .card h2 {
      margin: 0;
      font-size: 1.2rem;
      color: #ffdc90;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .word {
      font-family: 'Dancing Script', cursive;
      font-size: clamp(3rem, 12vw, 5.8rem);
      margin: 0.25rem 0 0.1rem;
      color: #ffe7a8;
      text-shadow: 3px 3px 0 #5f260f, 0 0 18px rgba(255, 227, 141, 0.35);
      line-height: 1;
    }

    .meaning {
      margin: 0.5rem auto 1rem;
      max-width: 420px;
      font-size: clamp(1.1rem, 2.6vw, 1.6rem);
      color: #fff0ca;
    }

    .card-actions {
      display: flex;
      justify-content: center;
      gap: 0.7rem;
      flex-wrap: wrap;
    }

    .note {
      font-size: 1rem;
      color: #e2c07a;
      margin-top: 0.65rem;
      min-height: 1.3em;
    }

    @media (max-width: 540px) {
      .dialog { padding: 0.8rem; }
      .pixel-btn { width: 100%; }
      .input-wrap { gap: 0.6rem; }
      input[type='text'] { min-width: 100%; }
    }
  </style>
</head>
<body class="scanline">
  <main class="dialog" aria-live="polite">
    <h1>TIỆM CHỮ PIXEL 2026</h1>
    <p id="npcText" class="npc-line">Hế lô! Ta là Cyber Đồ. Năm nay muốn phi nước đại hay đi nước kiệu?</p>

    <section id="stepStart">
      <button class="pixel-btn" id="btnXinChu">XIN CHỮ</button>
    </section>

    <section id="stepInput" class="hidden">
      <p class="npc-line" style="min-height:auto; margin-bottom:0.2rem;">Nhập mong muốn năm 2026 của bạn:</p>
      <div class="input-wrap">
        <input id="wishInput" type="text" placeholder="Muốn thoát ế, lương x5, sếp bớt dí..." maxlength="140" />
        <button class="pixel-btn" id="btnSend">GỬI VŨ TRỤ</button>
      </div>
    </section>

    <section id="stepLoading" class="hidden">
      <div class="loading">
        <span>Đang tải dữ liệu từ vũ trụ</span>
        <span class="dot"></span><span class="dot"></span><span class="dot"></span>
      </div>
    </section>
  </main>

  <section id="resultOverlay" class="overlay hidden" aria-modal="true" role="dialog">
    <div class="card">
      <h2>Lucky Card</h2>
      <div id="resultWord" class="word">PHÁT</div>
      <p id="resultMeaning" class="meaning">Phát lên như pháo, tiền vào ào ào.</p>
      <div class="card-actions">
        <button class="pixel-btn" id="btnRetry">CẦU THÊM</button>
        <button class="pixel-btn" id="btnShare">CHIA SẺ</button>
      </div>
      <p id="shareStatus" class="note"></p>
    </div>
  </section>

  <script>
    // ===== Gemini configuration =====
    const GEMINI_API_KEY = 'YOUR_KEY_HERE';
    const GEMINI_MODEL = 'gemini-1.5-flash';
    const FALLBACK_RESULT = {
      word: 'LỘC',
      meaning: 'Lộc tới đầy nhà, code chạy mượt mà.'
    };

    // ===== UI elements =====
    const stepStart = document.getElementById('stepStart');
    const stepInput = document.getElementById('stepInput');
    const stepLoading = document.getElementById('stepLoading');
    const resultOverlay = document.getElementById('resultOverlay');
    const wishInput = document.getElementById('wishInput');
    const resultWord = document.getElementById('resultWord');
    const resultMeaning = document.getElementById('resultMeaning');
    const shareStatus = document.getElementById('shareStatus');

    // ===== Tiny base64 wav sounds (8-bit inspired blips) =====
    const SOUND_SOURCES = {
      click: 'data:audio/wav;base64,UklGRlQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YTAAAAAAAP8AAP8AAAD//wAA//8AAP8AAP8AAAD//wAA',
      xinchu: 'data:audio/wav;base64,UklGRmQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YUAAAAAAAP8A/wAA//8AAAD//wAAAP8A/wAA//8AAAAAAP//AA==',
      success: 'data:audio/wav;base64,UklGRnQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YVAAAAAA/wAAAP8AAP//AAD//wAAAP8AAP8AAAD//wAA//8AAP8AAP8AAAAA'
    };

    const sounds = Object.fromEntries(
      Object.entries(SOUND_SOURCES).map(([k, src]) => {
        const a = new Audio(src);
        a.preload = 'auto';
        a.loop = false;
        return [k, a];
      })
    );

    function playSound(name) {
      const s = sounds[name];
      if (!s) return;
      s.currentTime = 0;
      s.play().catch(() => {});
    }

    function toInputStep() {
      stepStart.classList.add('hidden');
      stepLoading.classList.add('hidden');
      stepInput.classList.remove('hidden');
      resultOverlay.classList.add('hidden');
      shareStatus.textContent = '';
      requestAnimationFrame(() => wishInput.focus());
    }

    function toLoadingStep() {
      stepInput.classList.add('hidden');
      stepStart.classList.add('hidden');
      stepLoading.classList.remove('hidden');
    }

    function showResult(data) {
      resultWord.textContent = (data.word || FALLBACK_RESULT.word).toUpperCase();
      resultMeaning.textContent = data.meaning || FALLBACK_RESULT.meaning;
      stepLoading.classList.add('hidden');
      resultOverlay.classList.remove('hidden');
      playSound('success');
    }

    async function callGeminiAPI(wish) {
      const endpoint = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`;
      const systemPrompt = `You are a funny, Gen Z Pixel Calligraphy Master.\nFrom the user's wish:\n1) Choose ONE powerful Vietnamese or Sino-Vietnamese word.\n2) Write ONE short rhyming fortune sentence under 20 words.\nReturn ONLY JSON:\n{ "word": "...", "meaning": "..." }`;

      if (!GEMINI_API_KEY || GEMINI_API_KEY === 'YOUR_KEY_HERE') {
        throw new Error('Missing Gemini API key');
      }

      const res = await fetch(endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ role: 'user', parts: [{ text: `Wish: ${wish}` }] }],
          systemInstruction: { role: 'system', parts: [{ text: systemPrompt }] },
          generationConfig: { temperature: 0.9, maxOutputTokens: 120 }
        })
      });

      if (!res.ok) throw new Error(`Gemini error ${res.status}`);
      const payload = await res.json();
      const rawText = payload?.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || '';

      const clean = rawText.replace(/```json|```/g, '').trim();
      const parsed = JSON.parse(clean);
      return {
        word: String(parsed.word || '').trim() || FALLBACK_RESULT.word,
        meaning: String(parsed.meaning || '').trim() || FALLBACK_RESULT.meaning
      };
    }

    function createShareImageDataUrl(word, meaning) {
      const canvas = document.createElement('canvas');
      canvas.width = 720;
      canvas.height = 420;
      const ctx = canvas.getContext('2d');

      ctx.fillStyle = '#24130b';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      ctx.fillStyle = '#91311f';
      ctx.fillRect(16, 16, canvas.width - 32, canvas.height - 32);

      ctx.fillStyle = '#f4cb69';
      ctx.fillRect(30, 30, canvas.width - 60, canvas.height - 60);

      ctx.fillStyle = '#38180d';
      ctx.fillRect(38, 38, canvas.width - 76, canvas.height - 76);

      ctx.fillStyle = '#fce9b2';
      ctx.font = 'bold 96px "Dancing Script", serif';
      ctx.textAlign = 'center';
      ctx.fillText(word.toUpperCase(), canvas.width / 2, 190);

      ctx.font = '36px "VT323", monospace';
      wrapText(ctx, meaning, canvas.width / 2, 255, 600, 44);

      ctx.font = '28px "VT323", monospace';
      ctx.fillStyle = '#f4cb69';
      ctx.fillText('TIỆM CHỮ PIXEL 2026', canvas.width / 2, 360);

      return canvas.toDataURL('image/png');
    }

    function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
      const words = text.split(' ');
      let line = '';
      let offsetY = 0;
      for (let n = 0; n < words.length; n++) {
        const test = line + words[n] + ' ';
        const width = ctx.measureText(test).width;
        if (width > maxWidth && n > 0) {
          ctx.fillText(line.trim(), x, y + offsetY);
          line = words[n] + ' ';
          offsetY += lineHeight;
        } else {
          line = test;
        }
      }
      ctx.fillText(line.trim(), x, y + offsetY);
    }

    async function shareResult() {
      const word = resultWord.textContent.trim();
      const meaning = resultMeaning.textContent.trim();
      const dataUrl = createShareImageDataUrl(word, meaning);
      const fileName = `tiem-chu-pixel-${Date.now()}.png`;
      shareStatus.textContent = '';

      try {
        const blob = await (await fetch(dataUrl)).blob();

        if (navigator.clipboard && window.ClipboardItem) {
          await navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })]);
          shareStatus.textContent = 'Đã copy ảnh vào clipboard!';
          return;
        }

        const tweetText = encodeURIComponent(`${word} — ${meaning} | TIỆM CHỮ PIXEL 2026`);
        window.open(`https://twitter.com/intent/tweet?text=${tweetText}`, '_blank', 'noopener');

        const a = document.createElement('a');
        a.href = dataUrl;
        a.download = fileName;
        a.textContent = 'Tải ảnh Lucky Card';
        a.style.color = '#ffe7a8';
        a.style.display = 'inline-block';
        a.style.marginTop = '0.5rem';

        shareStatus.innerHTML = 'Không copy trực tiếp được trên thiết bị này.';
        shareStatus.appendChild(document.createElement('br'));
        shareStatus.appendChild(a);
      } catch {
        shareStatus.textContent = 'Chia sẻ lỗi nhẹ. Bạn thử lại nhé!';
      }
    }

    // ===== Event wiring =====
    document.getElementById('btnXinChu').addEventListener('click', () => {
      playSound('click');
      playSound('xinchu');
      toInputStep();
    });

    document.getElementById('btnSend').addEventListener('click', async () => {
      playSound('click');
      const wish = wishInput.value.trim();
      if (!wish) {
        shareStatus.textContent = '';
        wishInput.focus();
        return;
      }

      toLoadingStep();

      try {
        const result = await callGeminiAPI(wish);
        showResult(result);
      } catch {
        showResult(FALLBACK_RESULT);
      }
    });

    wishInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') document.getElementById('btnSend').click();
    });

    document.getElementById('btnRetry').addEventListener('click', () => {
      playSound('click');
      wishInput.value = '';
      toInputStep();
    });

    document.getElementById('btnShare').addEventListener('click', () => {
      playSound('click');
      shareResult();
    });
  </script>
</body>
</html>
